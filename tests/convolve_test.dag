
// Convolves with a filter.
float[][] convolve(float[][] source,float[][] mask) {
  return for (int i0 : range(dim0(source) - 2)) {
    return for (int j0 : range(dim1(source) - 2)) {
      int i = i0 + 1;
      int j = j0 + 1;
      float[] temp = for (int k_1 : range(0, 3, 1)) {
	int k = k_1 - 1;
        float ii = source[i+k][j-1] * mask[k+1][0];
        float ij = source[i+k][j]   * mask[k+1][1];
        float ik = source[i+k][j+1] * mask[k+1][2];
        return ii + ij + ik;
      };
      return reduce(+, 0.0, temp);
    };
  };
}
